
# AI微积分助教Chrome插件开发规范

## 环境变量配置
```bash
# .env
DATABASE_URL=postgresql://postgres:bxw4gpgq@dbprovider.ap-southeast-1.clawcloudrun.com:40493/?directConnection=true
JWT_SECRET=wenhaogege
DEEPSEEK_API_KEY=sk-bddc9add46604b01a44ac29c4abd7152
MYSCRIPT_API_ENDPOINT=https://cloud.myscript.com/api/v4.0/iink
MYSCRIPT_WEBSOCKET_ENDPOINT=wss://cloud.myscript.com/api/v4.0/iink/ws
MYSCRIPT_APPLICATION_KEY=531d295e-bc63-47c1-bcb0-9a49b5a6fb46
MYSCRIPT_HMAC_KEY=c3bb9617-8d2e-4e6f-b4d2-1c9f8a2682fa
CHROMA_HOST=localhost
CHROMA_PORT=8000
MAX_FILE_SIZE=10485760
```

## 数据库Schema
```sql
-- 用户表
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    username VARCHAR(50) UNIQUE NOT NULL,
    email VARCHAR(100) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    role VARCHAR(20) NOT NULL DEFAULT 'student',
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

-- 作业提交表
CREATE TABLE submissions (
    id SERIAL PRIMARY KEY,
    student_id INTEGER REFERENCES users(id),
    title VARCHAR(200),
    file_urls TEXT[],
    myscript_result JSONB,
    ai_grading JSONB,
    score INTEGER,
    submitted_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

-- 错题记录表
CREATE TABLE error_records (
    id SERIAL PRIMARY KEY,
    submission_id INTEGER REFERENCES submissions(id),
    student_id INTEGER REFERENCES users(id),
    question_content JSONB,
    student_answer JSONB,
    correct_answer JSONB,
    error_type VARCHAR(50),
    knowledge_points TEXT[],
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);
```

## Chrome插件Manifest配置
```json
{
  "manifest_version": 3,
  "name": "AI微积分助教",
  "version": "1.0.0",
  "description": "智能微积分学习助手",
  
  "permissions": [
    "storage",
    "activeTab",
    "scripting"
  ],
  
  "host_permissions": [
    "https://ap-southeast-1.run.claw.cloud/*"
  ],
  
  "background": {
    "service_worker": "background/index.js"
  },
  
  "content_scripts": [
    {
      "matches": ["<all_urls>"],
      "js": ["content/index.js"],
      "css": ["content/styles.css"]
    }
  ],
  
  "action": {
    "default_popup": "popup/index.html"
  },
  
  "side_panel": {
    "default_path": "sidepanel/index.html"
  }
}
```

## API路由设计
```typescript
// 作业相关
POST   /api/submissions          // 提交作业
GET    /api/submissions/:id      // 获取作业详情
PUT    /api/submissions/:id      // 更新批改结果

// AI服务
POST   /api/ai/myscript         // MyScript手写识别
POST   /api/ai/grading          // Deepseek AI批改
POST   /api/ai/analysis         // 错题分析

// RAG服务 (预留)
POST   /api/rag/query           // 智能问答
GET    /api/rag/similar         // 查找相似题目

// 文件上传
POST   /api/upload              // 文件上传
```

## MyScript配置
```javascript
const myScriptConfig = {
  apiEndpoint: process.env.MYSCRIPT_API_ENDPOINT,
  wsEndpoint: process.env.MYSCRIPT_WEBSOCKET_ENDPOINT,
  applicationKey: process.env.MYSCRIPT_APPLICATION_KEY,
  hmacKey: process.env.MYSCRIPT_HMAC_KEY,
  recognitionParams: {
    type: 'MATH',
    protocol: 'REST',
    apiVersion: '4.0',
    mimeTypes: ['application/vnd.myscript.jiix', 'application/mathml+xml']
  }
};
```

## Deepseek AI配置
```javascript
const deepseekConfig = {
  apiKey: process.env.DEEPSEEK_API_KEY,
  baseURL: 'https://api.deepseek.com/v1',
  model: 'deepseek-chat',
  maxTokens: 4000
};
```

## Chroma配置 (预留)
```javascript
import { ChromaClient } from 'chromadb';
import { Chroma } from "langchain/vectorstores/chroma";

const chromaClient = new ChromaClient({
  path: process.env.CHROMA_HOST || 'http://localhost:8000'
});

const vectorStore = new Chroma(embeddings, {
  collectionName: "calculus_textbook",
  url: process.env.CHROMA_HOST || 'http://localhost:8000'
});
```

## 开发规范
- TypeScript严格模式
- 组件使用PascalCase命名
- API路由使用kebab-case
- 文件上传限制: 10MB
- 错误处理统一格式: `{ code, message, data }`
- 异步操作使用async/await
- Chrome Storage API用于本地缓存

## 文件上传处理
```javascript
// 支持的文件类型
const SUPPORTED_TYPES = [
  'application/pdf',
  'text/plain',
  'image/jpeg',
  'image/png'
];

// 文件处理流程
// 1. 验证文件类型和大小
// 2. 上传到服务器
// 3. PDF/图片提取文本
// 4. MyScript识别数学表达式
// 5. Deepseek AI批改
```
